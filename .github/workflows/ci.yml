name: Continuous Integration

on:
    push:
        branches: [ "master", "dev" ]
    pull_request:
        branches: [ "master", "dev" ]

jobs:
    build:

        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v2
    
        - name: install dependencies
          run: sudo apt-get install -y autoconf 

        - name: autoreconf install
          run: autoreconf --install
    
        - name: configure
          run: ./configure
    
        - name: make
          run: make
    
        - name: make check
          run: make check
    
        - name: make clean
          run: make clean
    
    clang-format:

        runs-on: ubuntu-latest
        
        steps:
        - name: Checkout repository
          uses: actions/checkout@v2
        
        - name: Install dependencies
          run: sudo apt-get install -y clang-format

        - name: Run clang-format
          run: find $(git rev-parse --show-toplevel) -name "*.h" -o -name "*.c" | xargs clang-format -i

        - name: Check for changes
          run: |
            git diff --exit-code
            if [ $? -eq 1 ]; then
                echo "Code is not clang-format compliant. Please format your code."
                exit 1
            fi

    doxygen:

        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Install dependencies
          run: sudo apt-get install -y doxygen graphviz

        - name: Run doxygen
          run: doxygen Doxyfile

        - name: specify the index.html in subdir
          run: git subtree push --prefix html origin gh-pages

        - name: deploy page
          uses: actions/deploy-pages@v4.0.3
          with:
            token: ${{ github.token }}
            timeout: 600000
            error_count: 10
            reporting_interval: 5000
            artifact_name: github-pages
            preview: false
